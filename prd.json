{
  "project": "Interactive Curve Fitting Lab",
  "branchName": "ralph/rational-exponential-fitting",
  "description": "Expand the curve fitting engine to reliably fit reciprocal/rational functions (1/x-like) and ensure exponential models are properly implemented, scored, and selectable. Fix auto-selector to prevent polynomial over-preference.",
  "nonGoals": [
    "General-purpose symbolic regression system",
    "High-degree rational models that are numerically unstable",
    "Complete UI redesign beyond model labels and equation formatting",
    "User accounts or authentication",
    "Session persistence or history"
  ],
  "assumptions": [
    "User has graduate-level math literacy",
    "Application runs as a local web app (localhost)",
    "Primary execution is fully offline",
    "Machine has ~16GB RAM available",
    "Maximum acceptable model runtime is 120 seconds",
    "Existing model registry and fitting pipeline are functional"
  ],
  "userStories": [
    {
      "id": "US-016",
      "epic": "E9: Reciprocal/Rational Model Support",
      "title": "Implement shifted reciprocal model family",
      "description": "As a user, I want the tool to fit curves like y = a/(x - c) + d so that I can model 1/x-like relationships.",
      "acceptanceCriteria": [
        "Backend implements ReciprocalShifted model: y = a/(x - c) + d",
        "Model returns NaN for x values where |x - c| < epsilon to avoid Infinity",
        "Fitted parameters (a, c, d) are exposed for UI display",
        "Model is added to the candidate set for automatic selection",
        "Typecheck passes",
        "Backend tests pass for reciprocal fitting"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Implemented fit_reciprocal_shifted with nonlinear fitting, multi-seed c estimation, and NaN-safe evaluation"
    },
    {
      "id": "US-017",
      "epic": "E9: Reciprocal/Rational Model Support",
      "title": "Plot reciprocal curves safely",
      "description": "As a user, I want reciprocal curves to render as separate segments without spikes across asymptotes.",
      "acceptanceCriteria": [
        "Frontend samples the fitted function across the viewport x-range",
        "Path breaks when y is NaN/Infinity or when |delta-y| exceeds discontinuity threshold",
        "Reciprocal curves plot as multiple segments with gap at asymptote",
        "No vertical spike is drawn across the asymptote x=c",
        "Typecheck passes",
        "Verify in browser: reciprocal curve renders correctly"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Implemented discontinuity detection with 50% y-range threshold; splits curve into segments at NaN/Inf and large jumps"
    },
    {
      "id": "US-018",
      "epic": "E10: Exponential Model Support",
      "title": "Implement exponential model family",
      "description": "As a user, I want the tool to fit exponential curves y = a * exp(b*x) + c so that exponential-like data is not incorrectly fit as polynomial.",
      "acceptanceCriteria": [
        "Backend implements 3-parameter exponential: y = a * exp(b*x) + c",
        "Evaluator clamps b*x to safe range or uses guarded exp to avoid Infinity",
        "Returns NaN if overflow occurs",
        "Model is added to the candidate set for automatic selection",
        "Typecheck passes",
        "Backend tests pass for exponential fitting"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Implemented safe_exp with MAX_EXP_ARG=700 overflow protection; NaN returned for overflow"
    },
    {
      "id": "US-019",
      "epic": "E10: Exponential Model Support",
      "title": "Fit exponential parameters robustly",
      "description": "As a user, I want exponential fitting to work reliably even with challenging data.",
      "acceptanceCriteria": [
        "Nonlinear least squares fitting implemented for exponential model",
        "Initial guesses work on common data: estimate c from min(y) or percentile",
        "Fit log(y-c) vs x to seed a and b when y > c",
        "If y values include negatives or cross zero, try multiple candidate c seeds",
        "If fitting fails (no valid c), mark exponential model invalid for that dataset",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Multi-seed c candidates including percentiles; log transform seeding for a,b; nonlinear refinement with curve_fit"
    },
    {
      "id": "US-020",
      "epic": "E10: Exponential Model Support",
      "title": "Display exponential model in UI",
      "description": "As a user, I want to see 'Exponential' in the Model field and the equation displayed clearly.",
      "acceptanceCriteria": [
        "UI Model label shows 'Exponential' when exponential model is selected",
        "Equation formatting shows exp() clearly: y = a * exp(bx) + c",
        "Exponential curve is plotted smoothly using fitted parameters",
        "Typecheck passes",
        "Verify in browser: exponential model displays correctly"
      ],
      "priority": 20,
      "passes": true,
      "notes": "Backend returns modelType='Exponential' and expression='y = a * exp(bx) + c'; frontend displays both in result panel"
    },
    {
      "id": "US-021",
      "epic": "E11: Fair Model Selection",
      "title": "Implement complexity-aware model selection",
      "description": "As a user, I want model selection to be fair across model families so that polynomials don't win just because they can overfit.",
      "acceptanceCriteria": [
        "If objective is 'Best Predictive Accuracy', use validation split or k-fold CV, not training error only",
        "Alternatively, apply complexity penalty (AIC/BIC-like) so higher-degree polynomials are penalized",
        "Cap polynomial degree (e.g., <= 4 or <= 6) unless user explicitly chooses higher",
        "All candidate families scored under same regime: Polynomial, Sinusoidal, Exponential, Logarithmic, Power, Reciprocal",
        "Typecheck passes",
        "Backend tests verify exponential can win when it generalizes better"
      ],
      "priority": 21,
      "passes": true,
      "notes": "Implemented 5-fold CV for accuracy objective; AIC-based scoring for interpretability/balanced; polynomial capped at degree 4"
    },
    {
      "id": "US-022",
      "epic": "E11: Fair Model Selection",
      "title": "Safe scoring with invalid evaluations",
      "description": "As a user, I want models with NaN/Infinity predictions to be handled safely without breaking the UI.",
      "acceptanceCriteria": [
        "When computing R2/RMSE/MAE, ignore points where model predicts NaN/Infinity",
        "Enforce minimum valid coverage threshold (>= 80% of points) for model to be considered",
        "Reject models that overflow frequently or have unstable predictions",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": true,
      "notes": "calculate_metrics filters NaN/Inf; fit_curve rejects models with <80% valid coverage; heuristics log rejections"
    },
    {
      "id": "US-023",
      "epic": "E12: Analysis for New Models",
      "title": "Derivatives and integrals for exponential model",
      "description": "As a user, I want to compute derivatives and integrals for exponential functions.",
      "acceptanceCriteria": [
        "Exponential derivative: if y = a*exp(bx)+c => y' = a*b*exp(bx), y'' = a*b^2*exp(bx)",
        "Integral computed via numeric integration if analytic not implemented",
        "Integration must be stable and accurate",
        "Typecheck passes",
        "Verify in browser: analysis works for exponential"
      ],
      "priority": 23,
      "passes": true,
      "notes": "Added preprocess_expression to fix coefficient*x patterns; sympy computes correct derivatives and integrals"
    },
    {
      "id": "US-024",
      "epic": "E12: Analysis for New Models",
      "title": "Derivatives and integrals for reciprocal model",
      "description": "As a user, I want to compute derivatives and integrals for reciprocal functions.",
      "acceptanceCriteria": [
        "Reciprocal derivative: y = a/(x-c)+d => y' = -a/(x-c)^2, y'' = 2a/(x-c)^3",
        "If integral bounds cross asymptote, show 'Integral undefined (bounds cross a vertical asymptote)'",
        "Typecheck passes",
        "Verify in browser: analysis works for reciprocal"
      ],
      "priority": 24,
      "passes": true,
      "notes": "Vertical asymptote detection via sp.together/sp.fraction; integrate endpoint checks bounds vs asymptotes"
    },
    {
      "id": "US-025",
      "epic": "E12: Analysis for New Models",
      "title": "UI warnings for asymptotes",
      "description": "As a user, I want subtle warnings when the fitted model has asymptotes in the viewport.",
      "acceptanceCriteria": [
        "If fitted model has asymptote within viewport, optionally show subtle badge 'asymptote in view'",
        "If exponential evaluation overflows, model is rejected (no warning unless debugging)",
        "Typecheck passes"
      ],
      "priority": 25,
      "passes": true,
      "notes": "Orange badge shown when modelType='Reciprocal'; exponential overflow handled silently via safe_exp returning NaN"
    },
    {
      "id": "US-026",
      "epic": "E13: Chart Zoom & Pan Polish",
      "title": "Cursor-centered zoom",
      "description": "As a user, I want zoom to be centered on where my cursor is pointing so that I can zoom into the exact region I care about without re-panning.",
      "acceptanceCriteria": [
        "Mouse wheel zoom keeps the world coordinate under the cursor stationary (cursor-anchored zoom)",
        "Zoom works smoothly in continuous steps without jumping",
        "Zoom clamped to min/max range to prevent infinite zoom"
      ],
      "priority": 26,
      "passes": true,
      "notes": "Implemented applyZoom with cursor-anchored algorithm; clampBounds enforces MIN_RANGE=0.1 and MAX_RANGE=1e6"
    },
    {
      "id": "US-027",
      "epic": "E13: Chart Zoom & Pan Polish",
      "title": "Smooth pan without fighting point interactions",
      "description": "As a user, I want dragging to pan to feel smooth and not interfere with point placement/selection.",
      "acceptanceCriteria": [
        "Click-drag pans the viewport when in navigation mode",
        "Space key enables pan mode even when painting mode is active",
        "Pan uses movement threshold (4px) before committing to prevent accidental triggers",
        "Dragging a point and panning are never triggered at the same time"
      ],
      "priority": 27,
      "passes": true,
      "notes": "Implemented interaction state machine with 'idle', 'panning', 'potentialPan' states; Space key modifier for pan in paint mode"
    },
    {
      "id": "US-028",
      "epic": "E13: Chart Zoom & Pan Polish",
      "title": "Trackpad gestures feel native",
      "description": "As a trackpad user, I want pinch zoom and two-finger pan to work naturally so the chart feels like modern map/canvas apps.",
      "acceptanceCriteria": [
        "Pinch zoom (ctrlKey) zooms around the pinch center",
        "Two-finger scroll pans the viewport when pointer is over the chart",
        "No conflict between scrolling the sidebar and interacting with the chart",
        "Updates throttled with requestAnimationFrame for smooth performance"
      ],
      "priority": 28,
      "passes": true,
      "notes": "Detects trackpad vs mouse wheel via deltaX presence and non-integer deltaY; pinch uses ctrlKey/metaKey; rAF throttling"
    },
    {
      "id": "US-029",
      "epic": "E13: Chart Zoom & Pan Polish",
      "title": "Fast reset and clear feedback",
      "description": "As a user, I want an easy way to reset zoom and understand the current scale so I don't get lost.",
      "acceptanceCriteria": [
        "A 'Reset View' button restores the default viewport (x:[-10,10], y:[-10,10])",
        "Zoom in/out buttons work and match wheel/pinch behavior",
        "Current viewport bounds are always displayed and update as user pans/zooms",
        "Interaction hints show contextual help (Scroll to zoom, Drag to pan, Space+drag)"
      ],
      "priority": 29,
      "passes": true,
      "notes": "Added +, -, Reset buttons in top-left; viewport bounds shown in bottom-left; interaction hints in top-right"
    },
    {
      "id": "US-030",
      "epic": "E14: Square Root & Logarithmic Model Support",
      "title": "Fit square-root curves",
      "description": "As a user, I want the tool to fit square-root functions so that I can model relationships that grow like sqrt(x).",
      "acceptanceCriteria": [
        "The engine can fit y = a * sqrt(x - c) + d when dataset resembles square-root relationship",
        "UI displays model label 'Square Root' and renders equation using âˆš notation",
        "Plotted curve only renders for x values where x - c >= 0 and breaks cleanly at boundary",
        "Model evaluation returns NaN for invalid domain inputs"
      ],
      "priority": 30,
      "passes": true,
      "notes": "Implemented fit_sqrt_shifted with multi-start c estimation; NaN-safe evaluation; 80% minimum valid coverage"
    },
    {
      "id": "US-031",
      "epic": "E14: Square Root & Logarithmic Model Support",
      "title": "Fit logarithmic curves with shift",
      "description": "As a user, I want the tool to fit logarithmic functions with horizontal shift so that I can model relationships that grow like ln(x).",
      "acceptanceCriteria": [
        "The engine can fit y = a * ln(x - c) + d when dataset resembles logarithmic relationship",
        "UI displays model label 'Logarithmic (Shifted)' and renders equation using ln notation",
        "Plotted curve only renders for x values where x - c > 0 and breaks cleanly at domain boundary",
        "Model evaluation returns NaN for invalid domain inputs"
      ],
      "priority": 31,
      "passes": true,
      "notes": "Implemented fit_log_shifted with multi-start c estimation; uses LinearRegression for initial a,d estimates; NaN-safe evaluation"
    },
    {
      "id": "US-032",
      "epic": "E14: Square Root & Logarithmic Model Support",
      "title": "Safe domain handling for sqrt/log",
      "description": "As a user, I want the app to handle sqrt/log undefined regions safely so nothing crashes and the curve doesn't draw nonsense.",
      "acceptanceCriteria": [
        "Model evaluation returns NaN for undefined inputs (sqrt/log domain violations)",
        "Plot sampling skips NaN points and breaks the curve path into valid segments",
        "Scoring ignores invalid predictions but enforces minimum 80% valid coverage threshold",
        "Integration refuses to compute if bounds include invalid domain and shows clear error"
      ],
      "priority": 32,
      "passes": true,
      "notes": "Domain boundary checking added to /integrate endpoint for sqrt and log; uses sp.atoms to find sqrt/log expressions"
    },
    {
      "id": "US-033",
      "epic": "E15: Multi-Start Model Selection",
      "title": "Multi-start candidate search for reliable fitting",
      "description": "As a user, I want the app to try multiple parameter initializations per model family so that it reliably finds the right model even when optimization is sensitive to initialization.",
      "acceptanceCriteria": [
        "For families with unstable optimization (sin/cos, exp, log, reciprocal), the engine tries multiple seeds and keeps the best result per family",
        "CandidateSearchEngine abstraction implemented with seed generation, fitting, scoring, and selection",
        "Sinusoidal model uses multi-start with frequency/phase grid search",
        "The selected model is the one with the best final score under the unified scoring protocol"
      ],
      "priority": 33,
      "passes": true,
      "notes": "Implemented CandidateSearchEngine with per-family seed generation; sinusoidal uses 12 seeds with autocorrelation-based frequency hints"
    },
    {
      "id": "US-034",
      "epic": "E15: Multi-Start Model Selection",
      "title": "Fair scoring across model families",
      "description": "As a user, I want model selection to remain fair across model families so that trying more seeds doesn't cause one family to always win.",
      "acceptanceCriteria": [
        "All families use the same scoring protocol (CV/holdout + complexity regularization)",
        "FinalScore = CV_RMSE + lambda*(k/N) where k = parameter count, lambda = 0.25",
        "For N >= 25: use 3-fold CV; for N < 25: use repeated holdout (3 repeats of 80/20 split)",
        "The only difference between families is their seed-generation strategy and parameter count"
      ],
      "priority": 34,
      "passes": true,
      "notes": "Unified scoring with CV_RMSE + complexity regularization; same lambda (0.25) applied to all families"
    },
    {
      "id": "US-035",
      "epic": "E15: Multi-Start Model Selection",
      "title": "Performance budget and adaptive search",
      "description": "As a user, I want the search to complete quickly while still finding good fits.",
      "acceptanceCriteria": [
        "Implement a time budget (max 3 seconds) and seed budget (max 60 seeds)",
        "Adaptive behavior: if time/seed budget exceeded, remaining families are skipped",
        "Early exit if an excellent fit is found (RMSE < 0.001)",
        "All skips recorded in trace with reason"
      ],
      "priority": 35,
      "passes": true,
      "notes": "3-second time budget, 60-seed budget; early exit on excellent fits; trace shows skipped families with reasons"
    },
    {
      "id": "US-036",
      "epic": "E15: Multi-Start Model Selection",
      "title": "Search trace for debugging",
      "description": "As a user, I want to see which models were tried and why the winner was chosen.",
      "acceptanceCriteria": [
        "Heuristics show total seeds tried and search time",
        "For each family: seeds tried, seeds valid, CV_RMSE, and status (selected/rejected/skipped/failed)",
        "Selected model marked with checkmark in heuristics",
        "Early exit reason shown if applicable"
      ],
      "priority": 36,
      "passes": true,
      "notes": "SearchTrace dataclass captures all candidate results; heuristics display formatted trace with checkmarks and CV metrics"
    }
  ]
}
